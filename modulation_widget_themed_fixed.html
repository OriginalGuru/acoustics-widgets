<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Modulation â€” Tremolo &amp; Vibrato</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --bg:      #0f1117;
    --surface: #181c27;
    --border:  #2a2f3f;
    --text:    #e4e8f0;
    --muted:   #7a8099;
    --accent:  #f0c040;
    --accent2: #4fc3f7;
    --btn-bg:  #1e2435;

    /* Canvas drawing tokens â€” dark defaults */
    --c-zero-line:   rgba(255,255,255,0.07);
    --c-period-tick: rgba(255,255,255,0.05);
    --c-axis-line:   rgba(255,255,255,0.10);
    --c-grid-line:   rgba(255,255,255,0.04);
    --c-ghost-slot:  rgba(255,255,255,0.03);
    --c-axis-label:  rgba(122,128,153,0.65);
    --c-muted-label: rgba(122,128,153,0.55);
    --c-muted-light: rgba(122,128,153,0.60);
    --c-freq-active: rgba(228,232,240,0.50);
    --c-freq-ghost:  rgba(122,128,153,0.25);
    --c-h-ghost:     rgba(122,128,153,0.40);
    --c-sum-line:    #f0c040;
    --c-play-text:   #0f1117;
    --c-carrier-lbl: rgba(240,192,64,0.70);
    --c-sideband-lbl:rgba(79,195,247,0.60);
    --c-env-baseline:rgba(255,255,255,0.07);
    --c-playhead:    rgba(255,255,255,0.72);
    --c-playhead-tip:rgba(255,255,255,0.85);
    --c-envelope-lbl:rgba(79,195,247,0.25);
    --c-center-tick: rgba(255,255,255,0.06);
  }

  [data-theme="light"] {
    --bg:      #f5f6fa;
    --surface: #ffffff;
    --border:  #d0d5e8;
    --text:    #1a1d2e;
    --muted:   #6b7280;
    --accent:  #c97e00;
    --accent2: #0077aa;
    --btn-bg:  #edf0f7;

    /* Canvas drawing tokens â€” light overrides */
    --c-zero-line:   rgba(0,0,0,0.08);
    --c-period-tick: rgba(0,0,0,0.05);
    --c-axis-line:   rgba(0,0,0,0.12);
    --c-grid-line:   rgba(0,0,0,0.05);
    --c-ghost-slot:  rgba(0,0,0,0.03);
    --c-axis-label:  rgba(80,90,120,0.70);
    --c-muted-label: rgba(80,90,120,0.65);
    --c-muted-light: rgba(80,90,120,0.60);
    --c-freq-active: rgba(30,35,60,0.55);
    --c-freq-ghost:  rgba(80,90,120,0.30);
    --c-h-ghost:     rgba(80,90,120,0.40);
    --c-sum-line:    #c97e00;
    --c-play-text:   #ffffff;
    --c-carrier-lbl: rgba(160,100,0,0.85);
    --c-sideband-lbl:rgba(0,100,160,0.75);
    --c-env-baseline:rgba(0,0,0,0.08);
    --c-playhead:    rgba(30,35,60,0.65);
    --c-playhead-tip:rgba(30,35,60,0.85);
    --c-envelope-lbl:rgba(0,100,160,0.30);
    --c-center-tick: rgba(0,0,0,0.06);
  }


  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 14px 40px;
  }

  h1 {
    font-family: 'DM Mono', monospace;
    font-size: 1.05rem;
    font-weight: 400;
    letter-spacing: 0.12em;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 3px;
  }
  .subtitle {
    color: var(--muted);
    font-size: 0.78rem;
    letter-spacing: 0.06em;
    margin-bottom: 18px;
  }

  .shell {
    width: 100%;
    max-width: 1140px;
    display: grid;
    grid-template-columns: 210px 1fr;
    grid-template-rows: auto auto auto;
    gap: 14px;
  }

  /* â”€â”€ CONTROLS â”€â”€ */
  .controls {
    grid-row: 1 / 4;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 14px;
    display: flex;
    flex-direction: column;
    gap: 18px;
    overflow-y: auto;
  }

  .ctrl-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    letter-spacing: 0.14em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .play-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    background: var(--accent);
    color: var(--c-play-text);
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    cursor: pointer;
    text-transform: uppercase;
    transition: opacity 0.14s, transform 0.1s;
  }
  .play-btn:hover  { opacity: 0.86; }
  .play-btn:active { transform: scale(0.97); }
  .play-btn.playing { background: #ef4444; color: #fff; }

  .btn-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

  .p-btn {
    background: var(--btn-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    padding: 7px 4px;
    cursor: pointer;
    text-align: center;
    transition: all 0.14s;
    letter-spacing: 0.03em;
  }
  .p-btn:hover { border-color: var(--accent); color: var(--accent); }
  .p-btn.active {
    background: var(--accent);
    color: var(--c-play-text);
    border-color: var(--accent);
    font-weight: 500;
  }

  /* slider rows */
  .slider-row { display: flex; flex-direction: column; gap: 5px; }
  .slider-label-row {
    display: flex; justify-content: space-between; align-items: baseline;
  }
  .slider-label {
    font-family: 'DM Mono', monospace; font-size: 0.62rem; color: var(--text);
  }
  .slider-val {
    font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--accent);
    font-weight: 500;
  }
  .slider-hint {
    font-size: 0.58rem; color: var(--muted); font-family: 'DM Mono', monospace;
  }
  input[type=range] {
    -webkit-appearance: none; appearance: none;
    width: 100%; height: 4px; background: var(--border);
    border-radius: 2px; outline: none; cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 13px; height: 13px;
    border-radius: 50%; background: var(--accent); cursor: pointer;
    border: none; transition: transform 0.1s;
  }
  input[type=range]::-webkit-slider-thumb:active { transform: scale(1.2); }
  input[type=range]::-moz-range-thumb {
    width: 13px; height: 13px; border-radius: 50%;
    background: var(--accent); cursor: pointer; border: none;
  }

  /* derived readout */
  .derived-readout {
    background: rgba(79,195,247,0.07);
    border: 1px solid rgba(79,195,247,0.2);
    border-radius: 6px;
    padding: 7px 10px;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--accent2);
    display: none;
  }
  .derived-readout.show { display: block; }

  /* dB toggle */
  .db-toggle {
    padding: 5px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--btn-bg);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    letter-spacing: 0.06em;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
    transition: all 0.14s;
  }
  .db-toggle:hover { border-color: var(--accent2); color: var(--accent2); }
  .db-toggle.active {
    border-color: var(--accent2);
    color: var(--accent2);
    background: rgba(79,195,247,0.08);
  }

  .panel-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px; gap: 8px;
  }
  .panel-header .panel-title { margin-bottom: 0; }

  /* â”€â”€ CANVAS PANELS â”€â”€ */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 18px 10px;
    display: flex;
    flex-direction: column;
  }
  .panel-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    letter-spacing: 0.14em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  canvas { width: 100%; border-radius: 3px; display: block; }

  /* pedagogical note */
  .ped-note {
    margin-top: 7px;
    font-size: 0.63rem;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    line-height: 1.5;
    border-left: 2px solid var(--border);
    padding-left: 8px;
  }

  .info-bar {
    grid-column: 1 / 3;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 9px 14px;
    font-size: 0.7rem;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.04em;
    display: flex; gap: 20px; flex-wrap: wrap;
  }
  .info-bar span { color: var(--text); }

  /* â”€â”€ DESKTOP â”€â”€ */
  @media (min-width: 700px) {
    body { padding: 20px 24px 40px; font-size: 13px; }
    h1 { font-size: 0.95rem; }
    .subtitle { font-size: 0.72rem; margin-bottom: 14px; }

    .shell {
      grid-template-columns: 190px 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 12px;
    }
    .controls {
      grid-row: 1 / 3; grid-column: 1;
      padding: 14px 12px; gap: 14px;
    }
    #panel-waveform  { grid-column: 2; grid-row: 1; }
    #panel-spectrum  { grid-column: 3; grid-row: 1; }
    .info-bar        { grid-column: 1 / 4; grid-row: 2; font-size: 0.65rem; padding: 7px 12px; gap: 16px; }

    #waveform-canvas { height: 170px; }
    #spectrum-canvas { height: 170px; }

    .panel       { padding: 11px 14px 8px; }
    .panel-title { font-size: 0.58rem; margin-bottom: 6px; }
    .ctrl-title  { font-size: 0.58rem; margin-bottom: 6px; }
    .play-btn    { padding: 10px; font-size: 0.72rem; }
    .p-btn       { font-size: 0.63rem; padding: 6px 3px; }
  }

  /* â”€â”€ THEME TOGGLE â”€â”€ */
  .theme-toggle {
    position: fixed;
    top: 14px;
    right: 16px;
    z-index: 100;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 5px 12px 5px 9px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--muted);
    letter-spacing: 0.06em;
    transition: border-color 0.15s, color 0.15s, background 0.2s;
    user-select: none;
    box-shadow: 0 1px 4px rgba(0,0,0,0.18);
  }
  .theme-toggle:hover { border-color: var(--accent); color: var(--text); }
  .theme-toggle .tog-icon { font-size: 0.9rem; line-height: 1; }
</style>
</head>
<body>

<button class="theme-toggle" id="theme-toggle" aria-label="Toggle light/dark theme">
  <span class="tog-icon" id="tog-icon">â˜€ï¸</span>
  <span id="tog-label">Light</span>
</button>

<h1>Modulation â€” Tremolo &amp; Vibrato</h1>
<p class="subtitle">A3 = 220 Hz &nbsp;Â·&nbsp; Amplitude and frequency modulation</p>

<div class="shell">

  <!-- CONTROLS -->
  <div class="controls">

    <div>
      <button class="play-btn" id="play-btn">â–¶ &nbsp;Play</button>
    </div>

    <!-- MODE -->
    <div>
      <div class="ctrl-title">Modulation mode</div>
      <div class="btn-grid-2">
        <button class="p-btn active" id="btn-am" data-mode="am">AM</button>
        <button class="p-btn"        id="btn-fm" data-mode="fm">FM</button>
      </div>
    </div>

    <!-- RATE -->
    <div class="slider-row">
      <div class="slider-label-row">
        <span class="slider-label">Rate Â· f<sub>m</sub></span>
        <span class="slider-val" id="val-fm">5.0 Hz</span>
      </div>
      <input type="range" id="sl-fm" min="0.5" max="20" step="0.1" value="5">
      <div class="slider-hint">modulation frequency</div>
    </div>

    <!-- DEPTH (AM) / DEVIATION (FM) -->
    <div class="slider-row">
      <div class="slider-label-row">
        <span class="slider-label" id="depth-label">Depth Â· m</span>
        <span class="slider-val"   id="val-depth">0.30</span>
      </div>
      <input type="range" id="sl-depth" min="0" max="1" step="0.01" value="0.3">
      <div class="slider-hint" id="depth-hint">0 = none, 1 = full tremolo</div>
    </div>

    <!-- FM-only derived readout -->
    <div class="derived-readout" id="beta-readout">
      Î² = Î”f / f<sub>m</sub> = <span id="beta-val">â€”</span>
    </div>

  </div>

  <!-- WAVEFORM -->
  <div class="panel" id="panel-waveform">
    <div class="panel-title" id="waveform-title">Waveform &nbsp;Â·&nbsp; time domain</div>
    <canvas id="waveform-canvas" height="210"></canvas>
  </div>

  <!-- SPECTRUM -->
  <div class="panel" id="panel-spectrum">
    <div class="panel-header">
      <div class="panel-title" id="spectrum-title">Spectrum &nbsp;Â·&nbsp; frequency domain &nbsp;Â·&nbsp; linear</div>
      <button class="db-toggle" id="db-toggle">Linear</button>
    </div>
    <canvas id="spectrum-canvas" height="210"></canvas>
    <div class="ped-note" id="ped-note">
      Tremolo adds exactly two sidebands. The spectrum is always three lines regardless of rate or depth.
    </div>
  </div>

  <!-- INFO BAR -->
  <div class="info-bar">
    <div>Carrier: <span>A3 = 220 Hz</span></div>
    <div id="info-mode">Mode: <span>AM (Tremolo)</span></div>
    <div id="info-fm">Rate f<sub>m</sub>: <span id="ispan-fm">5.0 Hz</span></div>
    <div id="info-depth">Depth m: <span id="ispan-depth">0.30</span></div>
  </div>

</div>

<script>
// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cssVar(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}
let isDark = true;
document.getElementById('theme-toggle').addEventListener('click', () => {
  isDark = !isDark;
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('tog-icon').textContent  = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
  document.getElementById('tog-label').textContent = isDark ? 'Light' : 'Dark';
  draw();
});

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const F0          = 220;
const SAMPLE_RATE = 44100;
const PLAY_DUR    = 2.0;
const DB_FLOOR    = -60;

const H_COLORS = [
  '#f87171','#fb923c','#fbbf24','#a3e635',
  '#34d399','#22d3ee','#60a5fa','#818cf8',
  '#c084fc','#f472b6','#fb7185','#e2e8f0'
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mode      = 'am';   // 'am' | 'fm'
let fm        = 5.0;    // modulation rate Hz
let depthAM   = 0.30;   // AM depth m âˆˆ [0,1]
let devFM     = 10.0;   // FM frequency deviation Î”f Hz
let specDb    = false;

let audioCtx  = null;
let toneSource = null;
let isPlaying  = false;

// Bessel J_n(x) -- Miller backward recurrence, correctly normalized
function besselJ(n, x) {
  const absN = Math.abs(n);
  // Edge case: x=0 -> J_0(0)=1, J_n(0)=0 for n!=0
  if (x === 0) return absN === 0 ? 1.0 : 0.0;

  // Start well above the desired order so the downward recurrence has decayed
  const M = absN + Math.max(60, Math.ceil(2.0 * Math.abs(x))) + 5;
  // Float64Array is zero-initialized
  const f = new Float64Array(M + 2);
  f[M - 1] = 1.0;   // arbitrary seed; will be scaled at the end

  for (let k = M - 1; k >= 1; k--) {
    f[k - 1] = (2.0 * k / x) * f[k] - f[k + 1];
    // Rescale the ENTIRE populated portion to prevent overflow
    if (Math.abs(f[k - 1]) > 1e150) {
      for (let q = 0; q <= M; q++) f[q] *= 1e-150;
    }
  }

  // Independent J_0(x) via power series to get absolute normalization
  // (converges for all finite x; 50 terms is more than sufficient for x <= 200)
  let j0 = 0.0, term = 1.0;
  const xh2 = (x * x) / 4.0;
  for (let k = 0; k < 50; k++) {
    j0   += (k % 2 === 0 ? 1.0 : -1.0) * term;
    term *= xh2 / ((k + 1.0) * (k + 1.0));
  }

  const scale = j0 / (f[0] || 1e-300);
  const val   = f[absN] * scale;
  // J_{-n}(x) = (-1)^n * J_n(x)
  return (n < 0 && absN % 2 === 1) ? -val : val;
}

// â”€â”€ Spectrum data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns array of {freq, amp, n, folded} where amp may be negative (for sign label)
function getSpectrum() {
  if (mode === 'am') {
    const m = depthAM;
    return [
      { freq: F0,      amp: 1.0,   n: 0,  folded: false },
      { freq: F0 + fm, amp: m / 2, n: 1,  folded: false },
      { freq: F0 - fm, amp: m / 2, n: -1, folded: false },
    ];
  } else {
    const beta = fm > 0 ? devFM / fm : 0;
    // Number of significant sidebands grows roughly as beta + 2 (Carson's rule);
    // cap at 30 for display clarity, but always show enough to capture energy.
    const NMAX_SIDE = Math.min(30, Math.max(15, Math.ceil(beta + 4)));
    const lines = [];
    for (let n = -NMAX_SIDE; n <= NMAX_SIDE; n++) {
      const jn  = besselJ(n, beta);
      if (Math.abs(jn) < 5e-3) continue;  // threshold on true Jn value
      let freq   = F0 + n * fm;
      let amp    = jn;
      let folded = false;
      if (freq < 0) {
        freq   = -freq;
        amp    = -amp;  // negative-frequency reflection flips sign
        folded = true;
      }
      lines.push({ freq, amp, n, folded });
    }
    return lines;
  }
}

// Normalize spectrum so max |amp| = 1
function normSpectrum(lines) {
  const maxA = Math.max(...lines.map(l => Math.abs(l.amp)), 1e-9);
  return lines.map(l => ({ ...l, normAmp: l.amp / maxA, absNorm: Math.abs(l.amp) / maxA }));
}

// â”€â”€ Canvas helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resizeCanvas(canvas) {
  const dpr  = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const needW = Math.round(rect.width  * dpr);
  const needH = Math.round(rect.height * dpr);
  if (canvas.width !== needW || canvas.height !== needH) {
    canvas.width  = needW;
    canvas.height = needH;
    canvas.getContext('2d').scale(dpr, dpr);
  }
}

// â”€â”€ Draw waveform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawWaveform() {
  const canvas = document.getElementById('waveform-canvas');
  resizeCanvas(canvas);
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.width / dpr, H = canvas.height / dpr;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, W, H);

  // Show 2â€“3 modulation cycles
  const tMax = Math.max(2 / fm, 0.005);
  const nPts = 1200;

  // Zero line
  ctx.strokeStyle = cssVar('--c-zero-line');
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(0, H/2); ctx.lineTo(W, H/2); ctx.stroke();

  // Envelope trace for AM
  if (mode === 'am') {
    const m = depthAM;
    ctx.strokeStyle = cssVar('--c-envelope-lbl');
    ctx.lineWidth = 1;
    ctx.setLineDash([3, 4]);
    ctx.beginPath();
    for (let xi = 0; xi < nPts; xi++) {
      const t = (xi / (nPts - 1)) * tMax;
      const env = (1 + m * Math.cos(2 * Math.PI * fm * t)) / (1 + m);
      const y = H/2 - (H * 0.42) * env;
      xi === 0 ? ctx.moveTo(xi / (nPts-1) * W, y) : ctx.lineTo(xi / (nPts-1) * W, y);
    }
    ctx.stroke();
    ctx.beginPath();
    for (let xi = 0; xi < nPts; xi++) {
      const t = (xi / (nPts - 1)) * tMax;
      const env = (1 + m * Math.cos(2 * Math.PI * fm * t)) / (1 + m);
      const y = H/2 + (H * 0.42) * env;
      xi === 0 ? ctx.moveTo(xi / (nPts-1) * W, y) : ctx.lineTo(xi / (nPts-1) * W, y);
    }
    ctx.stroke();
    ctx.setLineDash([]);
  }

  // Main waveform in gold
  ctx.strokeStyle = cssVar('--c-sum-line');
  ctx.lineWidth   = 2;
  ctx.beginPath();
  for (let xi = 0; xi < nPts; xi++) {
    const t = (xi / (nPts - 1)) * tMax;
    let v;
    if (mode === 'am') {
      const m = depthAM;
      v = (1 + m * Math.cos(2 * Math.PI * fm * t)) * Math.cos(2 * Math.PI * F0 * t);
      // Normalize to [-1,1]: max envelope is (1+m)
      v /= (1 + m) || 1;
    } else {
      const beta = fm > 0 ? devFM / fm : 0;
      v = Math.cos(2 * Math.PI * F0 * t + beta * Math.sin(2 * Math.PI * fm * t));
    }
    const y = H/2 - (H * 0.42) * v;
    xi === 0 ? ctx.moveTo(0, y) : ctx.lineTo(xi / (nPts-1) * W, y);
  }
  ctx.stroke();

  // Axis labels
  ctx.fillStyle = cssVar('--c-axis-label');
  ctx.font      = "9px 'DM Mono', monospace";
  ctx.textAlign = 'left';
  ctx.fillText('0', 4, H - 3);
  ctx.textAlign = 'right';
  ctx.fillText(`${(tMax * 1000).toFixed(1)} ms`, W - 4, H - 3);
}

// â”€â”€ Draw spectrum â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSpectrum() {
  const canvas = document.getElementById('spectrum-canvas');
  resizeCanvas(canvas);
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.width / dpr, H = canvas.height / dpr;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, W, H);

  const pL=42, pR=10, pT=26, pB=38;
  const iW = W - pL - pR, iH = H - pT - pB;

  const lines = getSpectrum();
  if (!lines.length) return;

  // Frequency axis spans all significant sidebands + margin.
  // AM: exactly +-fm sidebands, show +-4*fm (min 50 Hz).
  // FM: show the full sideband spread + 20% margin (min 50 Hz).
  let span;
  if (mode === 'am') {
    span = Math.max(fm * 4, 50);
  } else {
    const beta = fm > 0 ? devFM / fm : 0;
    const nSide = Math.min(30, Math.max(15, Math.ceil(beta + 4)));
    span = Math.max(nSide * fm * 1.2, 50);
  }
  const fMin  = Math.max(0, F0 - span);
  const fMax  = F0 + span;
  const fRange = fMax - fMin;

  // Axes
  ctx.strokeStyle = cssVar('--c-axis-line');
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pL, pT); ctx.lineTo(pL, pT + iH); ctx.lineTo(pL + iW, pT + iH);
  ctx.stroke();

  // Horizontal grid
  ctx.setLineDash([2, 4]);
  ctx.strokeStyle = cssVar('--c-grid-line');
  if (specDb) {
    for (const dbVal of [-20, -40, -60]) {
      const y = pT + (1 - dbVal / DB_FLOOR) * iH;
      ctx.beginPath(); ctx.moveTo(pL, y); ctx.lineTo(pL + iW, y); ctx.stroke();
    }
  } else {
    for (let g = 0.25; g < 1; g += 0.25) {
      const y = pT + iH * (1 - g);
      ctx.beginPath(); ctx.moveTo(pL, y); ctx.lineTo(pL + iW, y); ctx.stroke();
    }
  }
  ctx.setLineDash([]);

  // Normalization reference:
  // AM â€” carrier amplitude is 1.0 by construction; sidebands are m/2 â‰¤ 0.5. Use max |amp|.
  // FM â€” Bessel amplitudes are already on an absolute scale where J_0(0) = 1.0
  //      (unmodulated carrier = full amplitude). We must NOT renormalize to the
  //      largest present sideband, because at certain Î² values J_0 â‰ˆ 0 while
  //      higher sidebands remain large â€” renormalizing would make them exceed
  //      the carrier reference line, which is physically wrong.
  //      Fix: always use 1.0 as the reference for FM so the y-axis "1" means
  //      "same amplitude as the unmodulated carrier."
  const normRef = (mode === 'fm') ? 1.0 : Math.max(...lines.map(l => Math.abs(l.amp)), 1e-9);

  const DOT_R        = 4;     // dot radius px
  const STEM_W       = 1.5;   // stem line width
  const FOLDED_ALPHA = 0.45;

  lines.forEach(line => {
    const { freq, amp, n, folded } = line;
    const absAmp = Math.abs(amp);
    const normA  = absAmp / normRef;   // may be > 1 only if something is broken

    // x position
    const xFrac = (freq - fMin) / fRange;
    if (xFrac < -0.01 || xFrac > 1.01) return;
    const xC = pL + xFrac * iW;

    // Color by sideband order
    let col;
    if (n === 0) {
      col = '#f0c040';
    } else {
      const idx = (Math.abs(n) - 1) % H_COLORS.length;
      col = H_COLORS[idx];
    }

    // Stem height
    let stemH;
    if (specDb) {
      if (absAmp < 1e-9) return;
      // dB reference is normRef (= 1.0 for FM, carrier amplitude for AM)
      const dbVal = Math.max(20 * Math.log10(absAmp / normRef), DB_FLOOR);
      if (dbVal <= DB_FLOOR) return;
      stemH = (1 - dbVal / DB_FLOOR) * iH;
    } else {
      stemH = Math.min(normA, 1.0) * iH;   // clamp to plot height
    }
    if (stemH < 1) return;

    const yTip      = pT + iH - stemH;
    const yBaseline = pT + iH;

    ctx.globalAlpha = folded ? FOLDED_ALPHA : 1.0;

    // Stem line â€” dashed for folded components
    if (folded) ctx.setLineDash([3, 3]);
    ctx.strokeStyle = col;
    ctx.lineWidth   = STEM_W;
    ctx.beginPath();
    ctx.moveTo(xC, yBaseline);
    ctx.lineTo(xC, yTip);
    ctx.stroke();
    if (folded) ctx.setLineDash([]);

    // Dot at tip
    ctx.fillStyle = col;
    ctx.beginPath();
    ctx.arc(xC, yTip, DOT_R, 0, Math.PI * 2);
    ctx.fill();

    // Value label just above dot
    ctx.fillStyle = col;
    ctx.font      = "8px 'DM Mono', monospace";
    ctx.textAlign = 'center';
    const valStr  = specDb
      ? (20 * Math.log10(absAmp / normRef)).toFixed(0) + ' dB'
      : normA < 0.01 ? normA.toFixed(3) : normA.toFixed(2);
    ctx.fillText(valStr, xC, yTip - DOT_R - 3);

    // Sign label for FM (Bessel can be negative)
    if (mode === 'fm' && !folded) {
      const sign = amp < 0 ? 'âˆ’' : '+';
      ctx.fillText(sign, xC, yTip - DOT_R - 12);
    }

    ctx.globalAlpha = 1.0;
  });

  // Frequency axis labels: carrier and nearby sidebands
  ctx.fillStyle = cssVar('--c-muted-label');
  ctx.font      = "8px 'DM Mono', monospace";
  ctx.textAlign = 'center';

  // Always label carrier
  const xCarrier = pL + ((F0 - fMin) / fRange) * iW;
  ctx.fillStyle = cssVar('--c-carrier-lbl');
  ctx.fillText(`${F0}`, xCarrier, pT + iH + 11);

  // Label first two sidebands
  const labelsAt = mode === 'am'
    ? [F0 - fm, F0 + fm]
    : [F0 - fm, F0 + fm, F0 - 2*fm, F0 + 2*fm];
  labelsAt.forEach(f => {
    if (f < 0 || f < fMin || f > fMax) return;
    const xf = pL + ((f - fMin) / fRange) * iW;
    ctx.fillStyle = cssVar('--c-sideband-lbl');
    ctx.fillText(f < 1000 ? f.toFixed(0) : (f/1000).toFixed(2)+'k', xf, pT + iH + 11);
  });

  // Y-axis labels
  ctx.fillStyle = cssVar('--c-muted-label');
  ctx.font      = "8px 'DM Mono', monospace";
  ctx.textAlign = 'right';
  if (specDb) {
    ctx.fillText('0 dB', pL - 3, pT + 6);
    ctx.fillText('-20',  pL - 3, pT + (20/60) * iH + 4);
    ctx.fillText('-40',  pL - 3, pT + (40/60) * iH + 4);
    ctx.fillText('-60',  pL - 3, pT + iH + 4);
  } else {
    ctx.fillText('1',   pL - 3, pT + 6);
    ctx.fillText('0.5', pL - 3, pT + iH * 0.5 + 4);
    ctx.fillText('0',   pL - 3, pT + iH + 4);
  }

  // Rotated y-axis label
  ctx.save();
  ctx.fillStyle = cssVar('--c-muted-light');
  ctx.font      = "9px 'DM Mono', monospace";
  ctx.textAlign = 'center';
  ctx.translate(12, pT + iH / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillText(specDb ? 'dB (re. max)' : 'amplitude', 0, 0);
  ctx.restore();
}

function draw() { drawWaveform(); drawSpectrum(); }

// â”€â”€ Info bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateInfo() {
  document.querySelector('#info-mode span').textContent =
    mode === 'am' ? 'AM (Tremolo)' : 'FM (Vibrato)';
  document.getElementById('ispan-fm').textContent = fm.toFixed(1) + ' Hz';

  const depthEl = document.getElementById('info-depth');
  const ispan   = document.getElementById('ispan-depth');
  if (mode === 'am') {
    depthEl.innerHTML = 'Depth m: <span id="ispan-depth">' + depthAM.toFixed(2) + '</span>';
  } else {
    const beta = fm > 0 ? devFM / fm : 0;
    depthEl.innerHTML = 'Î”f: <span id="ispan-depth">' + devFM.toFixed(1) + ' Hz</span> &nbsp;Â·&nbsp; Î²: <span>' + beta.toFixed(2) + '</span>';
  }
}

// â”€â”€ Mode switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMode(m) {
  mode = m;
  document.getElementById('btn-am').classList.toggle('active', m === 'am');
  document.getElementById('btn-fm').classList.toggle('active', m === 'fm');

  const depthLabel = document.getElementById('depth-label');
  const depthHint  = document.getElementById('depth-hint');
  const sl         = document.getElementById('sl-depth');
  const valEl      = document.getElementById('val-depth');
  const betaEl     = document.getElementById('beta-readout');
  const pedNote    = document.getElementById('ped-note');

  if (m === 'am') {
    depthLabel.textContent = 'Depth Â· m';
    depthHint.textContent  = '0 = none, 1 = full tremolo';
    sl.min = 0; sl.max = 1; sl.step = 0.01; sl.value = depthAM;
    valEl.textContent = depthAM.toFixed(2);
    betaEl.classList.remove('show');
    pedNote.textContent = 'Tremolo adds exactly two sidebands. The spectrum is always three lines regardless of rate or depth.';
  } else {
    depthLabel.innerHTML = 'Deviation Â· Î”f (Hz)';
    depthHint.innerHTML  = 'Î² = Î”f / f<sub>m</sub>';
    sl.min = 0; sl.max = 100; sl.step = 0.5; sl.value = devFM;
    valEl.textContent = devFM.toFixed(1) + ' Hz';
    betaEl.classList.add('show');
    updateBeta();
    pedNote.textContent = 'Vibrato spreads energy across many sidebands. Î² = Î”f/fm controls how many are significant.';
  }

  updateInfo();
  draw();
}

function updateBeta() {
  const beta = fm > 0 ? devFM / fm : 0;
  document.getElementById('beta-val').textContent = beta.toFixed(2);
}

// â”€â”€ Audio synthesis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSignal() {
  const nS = Math.ceil(PLAY_DUR * SAMPLE_RATE);
  const buf = new Float32Array(nS);
  if (mode === 'am') {
    const m = depthAM;
    for (let s = 0; s < nS; s++) {
      const t = s / SAMPLE_RATE;
      buf[s] = (1 + m * Math.cos(2 * Math.PI * fm * t)) * Math.cos(2 * Math.PI * F0 * t);
    }
    // Normalize: max value is (1+m)
    const norm = 1 + m || 1;
    for (let s = 0; s < nS; s++) buf[s] /= norm;
  } else {
    const beta = fm > 0 ? devFM / fm : 0;
    for (let s = 0; s < nS; s++) {
      const t = s / SAMPLE_RATE;
      buf[s] = Math.cos(2 * Math.PI * F0 * t + beta * Math.sin(2 * Math.PI * fm * t));
    }
  }
  // Cosine fade in/out
  const fl = Math.min(2200, Math.floor(nS * 0.05));
  for (let i = 0; i < fl; i++) {
    const w = 0.5 * (1 - Math.cos(Math.PI * i / fl));
    buf[i]        *= w;
    buf[nS-1 - i] *= w;
  }
  return buf;
}

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function stopTone() {
  if (toneSource) { try { toneSource.stop(); } catch(e) {} toneSource = null; }
  isPlaying = false;
  const btn = document.getElementById('play-btn');
  btn.innerHTML = 'â–¶ &nbsp;Play';
  btn.classList.remove('playing');
}

function playTone() {
  if (isPlaying) { stopTone(); return; }
  const ac   = getAudioCtx();
  const nS   = Math.ceil(PLAY_DUR * SAMPLE_RATE);
  const sig  = buildSignal();
  const buf  = ac.createBuffer(1, nS, SAMPLE_RATE);
  buf.copyToChannel(sig, 0);
  const src  = ac.createBufferSource();
  src.buffer = buf;
  src.connect(ac.destination);
  src.start();
  src.onended = stopTone;
  toneSource = src;
  isPlaying  = true;
  const btn  = document.getElementById('play-btn');
  btn.innerHTML = 'â–  &nbsp;Stop';
  btn.classList.add('playing');
}

// â”€â”€ Event listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-am').addEventListener('click', () => setMode('am'));
document.getElementById('btn-fm').addEventListener('click', () => setMode('fm'));
document.getElementById('play-btn').addEventListener('click', playTone);

document.getElementById('sl-fm').addEventListener('input', e => {
  fm = parseFloat(e.target.value);
  document.getElementById('val-fm').textContent = fm.toFixed(1) + ' Hz';
  if (mode === 'fm') updateBeta();
  updateInfo();
  draw();
});

document.getElementById('sl-depth').addEventListener('input', e => {
  const v = parseFloat(e.target.value);
  if (mode === 'am') {
    depthAM = v;
    document.getElementById('val-depth').textContent = v.toFixed(2);
  } else {
    devFM = v;
    document.getElementById('val-depth').textContent = v.toFixed(1) + ' Hz';
    updateBeta();
  }
  updateInfo();
  draw();
});

document.getElementById('db-toggle').addEventListener('click', () => {
  specDb = !specDb;
  const btn = document.getElementById('db-toggle');
  btn.textContent = specDb ? 'dB' : 'Linear';
  btn.classList.toggle('active', specDb);
  document.getElementById('spectrum-title').innerHTML = specDb
    ? 'Spectrum &nbsp;Â·&nbsp; frequency domain &nbsp;Â·&nbsp; dB (re. max)'
    : 'Spectrum &nbsp;Â·&nbsp; frequency domain &nbsp;Â·&nbsp; linear';
  drawSpectrum();
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setMode('am');

let rzTimer;
window.addEventListener('resize', () => { clearTimeout(rzTimer); rzTimer = setTimeout(draw, 80); });
requestAnimationFrame(draw);
</script>
</body>
</html>
