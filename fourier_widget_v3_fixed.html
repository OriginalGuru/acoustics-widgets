<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fourier Synthesis — Sound Spectra</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --bg:      #0f1117;
    --surface: #181c27;
    --border:  #2a2f3f;
    --text:    #e4e8f0;
    --muted:   #7a8099;
    --accent:  #f0c040;
    --accent2: #4fc3f7;
    --btn-bg:  #1e2435;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 14px 40px;
  }

  h1 {
    font-family: 'DM Mono', monospace;
    font-size: 1.05rem;
    font-weight: 400;
    letter-spacing: 0.12em;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 3px;
  }
  .subtitle {
    color: var(--muted);
    font-size: 0.78rem;
    letter-spacing: 0.06em;
    margin-bottom: 18px;
  }

  .shell {
    width: 100%;
    max-width: 1140px;
    display: grid;
    grid-template-columns: 210px 1fr;
    grid-template-rows: auto auto auto;
    gap: 14px;
  }

  /* ── CONTROLS ── */
  .controls {
    grid-row: 1 / 4;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 14px;
    display: flex;
    flex-direction: column;
    gap: 18px;
    overflow-y: auto;
  }

  .ctrl-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    letter-spacing: 0.14em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  /* play button — full width, at top */
  .play-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    background: var(--accent);
    color: #0f1117;
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    cursor: pointer;
    text-transform: uppercase;
    transition: opacity 0.14s, transform 0.1s;
  }
  .play-btn:hover  { opacity: 0.86; }
  .play-btn:active { transform: scale(0.97); }
  .play-btn.playing { background: #ef4444; color: #fff; }

  /* preset buttons */
  .btn-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

  .p-btn {
    background: var(--btn-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    padding: 7px 4px;
    cursor: pointer;
    text-align: center;
    transition: all 0.14s;
    letter-spacing: 0.03em;
  }
  .p-btn:hover { border-color: var(--accent); color: var(--accent); }
  .p-btn.active {
    background: var(--accent);
    color: #0f1117;
    border-color: var(--accent);
    font-weight: 500;
  }

  /* harmonic checkboxes */
  .harmonic-list { display: flex; flex-direction: column; gap: 5px; }
  .h-row {
    display: flex; align-items: center; gap: 7px;
    cursor: pointer; user-select: none;
  }
  .h-row input[type=checkbox] { display: none; }
  .h-dot {
    width: 10px; height: 10px; border-radius: 2px;
    border: 1.5px solid; flex-shrink: 0;
    transition: background 0.13s;
  }
  .h-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.66rem;
    color: var(--muted);
    flex: 1;
    transition: color 0.13s;
  }
  .h-row.on .h-label { color: var(--text); }

  /* dB toggle — inline in panel header */
  .db-toggle {
    padding: 5px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--btn-bg);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    letter-spacing: 0.06em;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
    transition: all 0.14s;
  }
  .db-toggle:hover { border-color: var(--accent2); color: var(--accent2); }
  .db-toggle.active {
    border-color: var(--accent2);
    color: var(--accent2);
    background: rgba(79,195,247,0.08);
  }

  /* amplitude buttons */
  .amp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
  .a-btn {
    background: var(--btn-bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    padding: 6px 3px;
    cursor: pointer;
    text-align: center;
    transition: all 0.14s;
    line-height: 1.4;
  }
  .a-btn:hover  { border-color: var(--accent2); color: var(--accent2); }
  .a-btn.active { border-color: var(--accent2); color: var(--accent2); background: rgba(79,195,247,0.08); }

  /* panel header: title + toggle inline */
  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
    gap: 8px;
  }
  .panel-header .panel-title { margin-bottom: 0; }

  /* ── CANVAS PANELS ── */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 18px 10px;
    display: flex;
    flex-direction: column;
  }
  .panel-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    letter-spacing: 0.14em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  canvas { width: 100%; border-radius: 3px; display: block; }

  .legend {
    display: flex; flex-wrap: wrap; gap: 6px 12px; margin-top: 8px;
  }
  .leg-item {
    display: flex; align-items: center; gap: 4px;
    font-family: 'DM Mono', monospace; font-size: 0.58rem; color: var(--muted);
  }
  .leg-sw { width: 16px; height: 2px; border-radius: 1px; }

  .info-bar {
    grid-column: 1 / 3;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 9px 14px;
    font-size: 0.7rem;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.04em;
    display: flex; gap: 20px; flex-wrap: wrap;
  }
  .info-bar span { color: var(--text); }

  /* ── DESKTOP LAYOUT (≥ 700px) ── */
  @media (min-width: 700px) {
    body { padding: 20px 24px 40px; font-size: 13px; }

    h1 { font-size: 0.95rem; }
    .subtitle { font-size: 0.72rem; margin-bottom: 14px; }

    .shell {
      /* controls | waveform | spectrum */
      grid-template-columns: 190px 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 12px;
    }

    .controls {
      grid-row: 1 / 3;
      grid-column: 1;
      padding: 14px 12px;
      gap: 14px;
    }

    /* waveform top-right, spectrum bottom-right */
    #panel-waveform {
      grid-column: 2; grid-row: 1;
    }
    #panel-spectrum {
      grid-column: 3; grid-row: 1;
    }
    .info-bar {
      grid-column: 1 / 4;
      grid-row: 2;
      font-size: 0.65rem;
      padding: 7px 12px;
      gap: 16px;
    }

    /* smaller canvases on desktop */
    #waveform-canvas { height: 170px; }
    #spectrum-canvas { height: 170px; }

    .panel { padding: 11px 14px 8px; }
    .panel-title { font-size: 0.58rem; margin-bottom: 6px; }

    .ctrl-title { font-size: 0.58rem; margin-bottom: 6px; }

    .play-btn { padding: 10px; font-size: 0.72rem; }

    .p-btn { font-size: 0.63rem; padding: 6px 3px; }
    .a-btn { font-size: 0.58rem; padding: 5px 3px; }

    .h-label { font-size: 0.61rem; }
    .h-dot   { width: 9px; height: 9px; }

    .legend { gap: 4px 10px; margin-top: 6px; }
    .leg-item { font-size: 0.54rem; }
  }
</style>
</head>
<body>

<h1>Fourier Synthesis</h1>
<p class="subtitle">A3 = 220 Hz &nbsp;·&nbsp; Build a sound from sine waves</p>

<div class="shell">

  <!-- CONTROLS -->
  <div class="controls">

    <!-- PLAY — top of controls -->
    <div>
      <button class="play-btn" id="play-btn">▶ &nbsp;Play</button>
    </div>

    <!-- WAVEFORM PRESETS -->
    <div>
      <div class="ctrl-title">Waveform preset</div>
      <div class="btn-grid-2">
        <button class="p-btn" data-preset="sine">Sine</button>
        <button class="p-btn" data-preset="square">Square</button>
        <button class="p-btn" data-preset="sawtooth">Sawtooth</button>
        <button class="p-btn" data-preset="triangle">Triangle</button>
      </div>
    </div>

    <!-- HARMONICS -->
    <div>
      <div class="ctrl-title">Harmonics (n = 1 – 12)</div>
      <div class="harmonic-list" id="harmonic-list"></div>
    </div>

    <!-- AMPLITUDE SHAPE -->
    <div>
      <div class="ctrl-title">Amplitude shape</div>
      <div class="amp-grid">
        <button class="a-btn active" data-amp="equal">Equal</button>
        <button class="a-btn" data-amp="inv_n">A ∝ 1/n</button>
        <button class="a-btn" data-amp="inv_n2">A ∝ 1/n²</button>
        <button class="a-btn" data-amp="custom">Fund.<br>dominant</button>
      </div>
    </div>

  </div>

  <!-- TIME DOMAIN -->
  <div class="panel" id="panel-waveform">
    <div class="panel-title">Waveform &nbsp;·&nbsp; time domain &nbsp;(A3, ~16 ms shown)</div>
    <canvas id="waveform-canvas" height="210"></canvas>
    <div class="legend" id="waveform-legend"></div>
  </div>

  <!-- FREQUENCY DOMAIN -->
  <div class="panel" id="panel-spectrum">
    <div class="panel-header">
      <div class="panel-title" id="spectrum-title">Spectrum &nbsp;·&nbsp; frequency domain &nbsp;·&nbsp; linear</div>
      <button class="db-toggle" id="db-toggle">Linear</button>
    </div>
    <canvas id="spectrum-canvas" height="210"></canvas>
  </div>

  <!-- INFO BAR -->
  <div class="info-bar">
    <div>Fundamental: <span>A3 = 220 Hz</span></div>
    <div id="info-h">Active harmonics: <span>—</span></div>
    <div id="info-f">Frequencies: <span>—</span></div>
  </div>

</div>

<script>
// ── Constants ──────────────────────────────────────────────────────────────────
const F0          = 220;       // A3 fundamental, Hz
const N_HARM      = 12;        // harmonics n=1..12
const SAMPLE_RATE = 44100;
const PLAY_DUR    = 2.0;       // seconds
// Show 3.5 periods of F0 in the time domain (~15.9 ms).
// Long enough to read the waveform shape; short enough that individual
// high-harmonic oscillations are visible within the window.
const SHOW_SEC = 3.5 / F0;

// 12 perceptually distinct colors, one per harmonic
const H_COLORS = [
  '#f87171','#fb923c','#fbbf24','#a3e635',
  '#34d399','#22d3ee','#60a5fa','#818cf8',
  '#c084fc','#f472b6','#fb7185','#e2e8f0'
];

// ── State ──────────────────────────────────────────────────────────────────────
let activeH = new Array(N_HARM).fill(false);
let amps    = new Array(N_HARM).fill(1.0);
// phases[i]: 0 or Math.PI — used by the triangle preset to implement
// the alternating-sign series  sin(f) - (1/9)sin(3f) + (1/25)sin(5f) - ...
// All other presets leave phases at 0.
let phases  = new Array(N_HARM).fill(0);
let ampMode = 'equal';

let audioCtx    = null;
let toneSource  = null;
let isPlaying   = false;
let specDb      = false;  // false = linear, true = dB

// ── Amplitude presets ──────────────────────────────────────────────────────────
function applyAmpMode(mode) {
  ampMode = mode;
  for (let i = 0; i < N_HARM; i++) {
    const n = i + 1;
    if      (mode === 'equal')  amps[i] = 1.0;
    else if (mode === 'inv_n')  amps[i] = 1.0 / n;
    else if (mode === 'inv_n2') amps[i] = 1.0 / (n * n);
    else if (mode === 'custom') amps[i] = (i === 0) ? 1.0 : 0.15 / n;
  }
}

// ── Waveform presets ───────────────────────────────────────────────────────────
// Triangle: odd harmonics only, A∝1/n², phases alternate 0/π so that
// consecutive active harmonics have opposite sign — this is the correct
// Fourier series for a triangle wave and differs from square only in
// the phase pattern and the 1/n² amplitude falloff.
function applyPreset(name) {
  phases.fill(0);
  if (name === 'sine') {
    activeH.fill(false); activeH[0] = true;
    applyAmpMode('equal'); syncAmpBtns('equal');
  } else if (name === 'square') {
    activeH.fill(false);
    for (let i = 0; i < N_HARM; i += 2) activeH[i] = true; // n=1,3,5,7,9,11
    applyAmpMode('inv_n'); syncAmpBtns('inv_n');
  } else if (name === 'sawtooth') {
    activeH.fill(true);
    applyAmpMode('inv_n'); syncAmpBtns('inv_n');
  } else if (name === 'triangle') {
    activeH.fill(false);
    let phaseToggle = 0;
    for (let i = 0; i < N_HARM; i += 2) {   // odd harmonics: i=0,2,4,6,8,10
      activeH[i] = true;
      phases[i]  = phaseToggle * Math.PI;    // 0, π, 0, π ...
      phaseToggle = 1 - phaseToggle;
    }
    applyAmpMode('inv_n2'); syncAmpBtns('inv_n2');
  }
  syncCheckboxes();
  draw(); updateInfo();
}

// ── Synthesis ──────────────────────────────────────────────────────────────────
// Exact sample-by-sample additive synthesis. No shortcuts:
// the signal written to the audio buffer is computed from the same
// activeH[], amps[], phases[] arrays that drive the canvas plots.
// What you see in both panels is precisely what you hear.
function buildToneSignal(rootF, nSamples) {
  const buf  = new Float32Array(nSamples);
  const acts = [];
  let   maxA = 0;
  for (let i = 0; i < N_HARM; i++) {
    if (activeH[i]) {
      acts.push({ n: i + 1, a: amps[i], ph: phases[i] });
      maxA += amps[i];
    }
  }
  if (!acts.length || maxA === 0) return buf;
  for (let s = 0; s < nSamples; s++) {
    const t = s / SAMPLE_RATE;
    let v = 0;
    for (const { n, a, ph } of acts) {
      v += a * Math.sin(2 * Math.PI * n * rootF * t + ph);
    }
    buf[s] = v / maxA;   // normalize to [-1, 1]
  }
  return buf;
}

// ── Audio playback ─────────────────────────────────────────────────────────────
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function stopTone() {
  if (toneSource) { try { toneSource.stop(); } catch(e) {} toneSource = null; }
  isPlaying = false;
  const btn = document.getElementById('play-btn');
  btn.innerHTML = '▶ &nbsp;Play';
  btn.classList.remove('playing');
}

function playTone() {
  if (isPlaying) { stopTone(); return; }
  const ctx    = getAudioCtx();
  const nS     = Math.ceil(PLAY_DUR * SAMPLE_RATE);
  const signal = buildToneSignal(F0, nS);

  // Short cosine fade-in/out to suppress clicks at note boundaries
  const fl = Math.min(2200, Math.floor(nS * 0.05));
  for (let i = 0; i < fl; i++) {
    const w = 0.5 * (1 - Math.cos(Math.PI * i / fl));
    signal[i]        *= w;
    signal[nS-1 - i] *= w;
  }

  const buffer = ctx.createBuffer(1, nS, SAMPLE_RATE);
  buffer.copyToChannel(signal, 0);

  const src = ctx.createBufferSource();
  src.buffer = buffer;
  src.connect(ctx.destination);
  src.start();
  src.onended = stopTone;

  toneSource = src;
  isPlaying  = true;
  const btn  = document.getElementById('play-btn');
  btn.innerHTML = '■ &nbsp;Stop';
  btn.classList.add('playing');
}

// ── Canvas helpers ─────────────────────────────────────────────────────────────
function resizeCanvas(canvas) {
  const dpr  = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const needW = Math.round(rect.width  * dpr);
  const needH = Math.round(rect.height * dpr);
  if (canvas.width !== needW || canvas.height !== needH) {
    canvas.width  = needW;
    canvas.height = needH;
    canvas.getContext('2d').scale(dpr, dpr);
  }
}

// ── Draw waveform ──────────────────────────────────────────────────────────────
function drawWaveform() {
  const canvas = document.getElementById('waveform-canvas');
  resizeCanvas(canvas);
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.width / dpr, H = canvas.height / dpr;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, W, H);

  // Zero line
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  ctx.lineWidth = 1; ctx.setLineDash([]);
  ctx.beginPath(); ctx.moveTo(0, H/2); ctx.lineTo(W, H/2); ctx.stroke();

  // Period tick marks
  ctx.setLineDash([3, 5]);
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  for (let p = 1; p < 4; p++) {
    const x = (p / 3.5) * W;
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  ctx.setLineDash([]);

  const active = [];
  for (let i = 0; i < N_HARM; i++) if (activeH[i]) active.push(i);
  if (!active.length) return;

  const nPts = 900;
  const tMax = SHOW_SEC;

  // Vertical lane layout: harmonic n=1 near bottom, n=12 near top.
  // Each lane is a thin horizontal strip; the sine oscillates within it.
  // This lets all components be seen simultaneously without overlap.
  const laneZoneH = H * 0.42;
  const laneH     = laneZoneH / active.length;

  active.forEach((idx, rank) => {
    const n   = idx + 1;
    const col = H_COLORS[idx];
    const ph  = phases[idx];
    const cy  = H * 0.78 - rank * laneH;
    const amp = Math.min(laneH * 0.44, H * 0.055);

    ctx.strokeStyle = col;
    ctx.globalAlpha = 0.32;
    ctx.lineWidth   = 1.1;
    ctx.beginPath();
    for (let xi = 0; xi < nPts; xi++) {
      const t = (xi / (nPts - 1)) * tMax;
      const y = cy - amp * Math.sin(2 * Math.PI * n * F0 * t + ph);
      xi === 0 ? ctx.moveTo(0, y) : ctx.lineTo((xi / (nPts - 1)) * W, y);
    }
    ctx.stroke();
    ctx.globalAlpha = 1;
  });

  // Bold sum — normalized by sum of amplitudes
  let maxA = 0;
  for (let i = 0; i < N_HARM; i++) if (activeH[i]) maxA += amps[i];

  ctx.strokeStyle = '#f0c040';
  ctx.lineWidth   = 2.5;
  ctx.beginPath();
  for (let xi = 0; xi < nPts; xi++) {
    const t = (xi / (nPts - 1)) * tMax;
    let v = 0;
    for (let i = 0; i < N_HARM; i++) {
      if (activeH[i]) v += amps[i] * Math.sin(2 * Math.PI * (i+1) * F0 * t + phases[i]);
    }
    const y = H/2 - (H * 0.36) * (v / maxA);
    xi === 0 ? ctx.moveTo(0, y) : ctx.lineTo((xi / (nPts - 1)) * W, y);
  }
  ctx.stroke();

  // Axis labels
  ctx.fillStyle = 'rgba(122,128,153,0.65)';
  ctx.font      = "9px 'DM Mono', monospace";
  ctx.fillText('0', 4, H - 3);
  ctx.fillText(`${(tMax * 1000).toFixed(1)} ms`, W - 44, H - 3);
}

// ── Draw spectrum ──────────────────────────────────────────────────────────────
function drawSpectrum() {
  const canvas = document.getElementById('spectrum-canvas');
  resizeCanvas(canvas);
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.width / dpr, H = canvas.height / dpr;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, W, H);

  const pL=38, pR=10, pT=26, pB=38;
  const iW = W-pL-pR, iH = H-pT-pB;

  const DB_FLOOR = -60;  // dB minimum shown

  // Axes
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pL, pT); ctx.lineTo(pL, pT+iH); ctx.lineTo(pL+iW, pT+iH);
  ctx.stroke();

  // Horizontal grid lines
  ctx.setLineDash([2, 4]);
  ctx.strokeStyle = 'rgba(255,255,255,0.04)';
  if (specDb) {
    // dB grid: 0, -20, -40, -60
    for (const dbVal of [-20, -40, -60]) {
      const y = pT + iH * (dbVal / DB_FLOOR);
      ctx.beginPath(); ctx.moveTo(pL, y); ctx.lineTo(pL+iW, y); ctx.stroke();
    }
  } else {
    for (let g = 0.25; g < 1; g += 0.25) {
      const y = pT + iH * (1 - g);
      ctx.beginPath(); ctx.moveTo(pL, y); ctx.lineTo(pL+iW, y); ctx.stroke();
    }
  }
  ctx.setLineDash([]);

  const slotW = iW / N_HARM;

  for (let i = 0; i < N_HARM; i++) {
    const n   = i + 1;
    const freq = n * F0;
    const col = H_COLORS[i];
    const x   = pL + i * slotW + slotW * 0.18;
    const bw  = slotW * 0.64;
    const a   = activeH[i] ? amps[i] : 0;  // raw amplitude (always ≥ 0 in Fourier widget)

    if (activeH[i]) {
      let barH, valLabel;
      if (specDb) {
        const dbVal = Math.max(20 * Math.log10(Math.max(a, 1e-6)), DB_FLOOR);
        barH     = Math.max((1 - dbVal / DB_FLOOR) * iH, 1);
        valLabel = dbVal > DB_FLOOR + 1 ? dbVal.toFixed(1) + ' dB' : '≤' + DB_FLOOR + ' dB';
      } else {
        // Scale bars to the largest active amplitude
        let maxA = 0;
        for (let j = 0; j < N_HARM; j++) if (activeH[j]) maxA = Math.max(maxA, amps[j]);
        if (maxA === 0) maxA = 1;
        barH     = (a / maxA) * iH;
        const al = a < 0.01 ? a.toFixed(3) : a < 0.1 ? a.toFixed(3) : a.toFixed(2);
        valLabel = al;
      }

      const y = pT + iH - barH;
      const gr = ctx.createLinearGradient(0, y, 0, pT+iH);
      gr.addColorStop(0, col);
      gr.addColorStop(1, col + '28');
      ctx.fillStyle = gr;
      ctx.fillRect(x, y, bw, barH);

      // top cap
      ctx.fillStyle = col;
      ctx.fillRect(x, y, bw, 2);

      // value label above bar
      ctx.fillStyle  = col;
      ctx.font       = "8px 'DM Mono', monospace";
      ctx.textAlign  = 'center';
      ctx.fillText(valLabel, x + bw/2, y - 3);

    } else {
      // ghost slot
      ctx.fillStyle = 'rgba(255,255,255,0.03)';
      ctx.fillRect(x, pT, bw, iH);
    }

    // harmonic number
    ctx.fillStyle = activeH[i] ? col : 'rgba(122,128,153,0.4)';
    ctx.font      = "8px 'DM Mono', monospace";
    ctx.textAlign = 'center';
    ctx.fillText(`n${n}`, x + bw/2, pT+iH+11);

    // frequency label
    if (n <= 6 || n % 2 === 0) {
      ctx.fillStyle = activeH[i] ? 'rgba(228,232,240,0.5)' : 'rgba(122,128,153,0.25)';
      ctx.font      = "7px 'DM Mono', monospace";
      const fLabel  = freq >= 1000 ? (freq/1000).toFixed(2)+'k' : freq+'';
      ctx.fillText(fLabel, x + bw/2, pT+iH+21);
    }
  }

  // Y-axis labels
  ctx.fillStyle = 'rgba(122,128,153,0.55)';
  ctx.font      = "8px 'DM Mono', monospace";
  ctx.textAlign = 'right';
  if (specDb) {
    ctx.fillText('0 dB',        pL - 3, pT + 6);
    ctx.fillText('-20',         pL - 3, pT + iH * (20/60) + 4);
    ctx.fillText('-40',         pL - 3, pT + iH * (40/60) + 4);
    ctx.fillText('-60',         pL - 3, pT + iH + 4);
  } else {
    ctx.fillText('1',   pL - 3, pT + 6);
    ctx.fillText('0.5', pL - 3, pT + iH * 0.5 + 4);
    ctx.fillText('0',   pL - 3, pT + iH + 4);
  }

  // Rotated y-axis label
  ctx.save();
  ctx.fillStyle = 'rgba(122,128,153,0.6)';
  ctx.font      = "9px 'DM Mono', monospace";
  ctx.textAlign = 'center';
  ctx.translate(11, pT + iH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(specDb ? 'dB (re. |a|=1)' : 'amplitude', 0, 0);
  ctx.restore();
}

function draw() { drawWaveform(); drawSpectrum(); updateLegend(); }

// ── Legend ─────────────────────────────────────────────────────────────────────
function updateLegend() {
  const leg = document.getElementById('waveform-legend');
  leg.innerHTML = `<div class="leg-item"><div class="leg-sw" style="background:#f0c040;height:3px"></div>Sum</div>`;
  for (let i = 0; i < N_HARM; i++) {
    if (!activeH[i]) continue;
    leg.innerHTML += `<div class="leg-item"><div class="leg-sw" style="background:${H_COLORS[i]}"></div>n=${i+1} · ${(i+1)*F0} Hz</div>`;
  }
}

// ── Info bar ───────────────────────────────────────────────────────────────────
function updateInfo() {
  const ah = [], af = [];
  for (let i = 0; i < N_HARM; i++) if (activeH[i]) { ah.push(i+1); af.push((i+1)*F0+' Hz'); }
  document.querySelector('#info-h span').textContent = ah.length ? ah.map(n=>`n=${n}`).join(', ') : '—';
  document.querySelector('#info-f span').textContent = af.length ? af.join(', ') : '—';
}

// ── Checkbox UI ───────────────────────────────────────────────────────────────
function buildCheckboxes() {
  const list = document.getElementById('harmonic-list');
  list.innerHTML = '';
  for (let i = 0; i < N_HARM; i++) {
    const n = i+1, col = H_COLORS[i], freq = n*F0;
    const row = document.createElement('label');
    row.className   = 'h-row' + (activeH[i] ? ' on' : '');
    row.style.color = col;
    row.innerHTML   = `
      <input type="checkbox" data-idx="${i}" ${activeH[i] ? 'checked' : ''}>
      <div class="h-dot" style="border-color:${col};${activeH[i] ? `background:${col}` : ''}"></div>
      <span class="h-label">n=${n} · ${freq} Hz</span>`;
    row.querySelector('input').addEventListener('change', e => {
      const idx = +e.target.dataset.idx;
      activeH[idx] = e.target.checked;
      row.classList.toggle('on', e.target.checked);
      row.querySelector('.h-dot').style.background = e.target.checked ? col : '';
      // Manual toggle clears preset highlight
      document.querySelectorAll('.p-btn[data-preset]').forEach(b => b.classList.remove('active'));
      draw(); updateInfo();
    });
    list.appendChild(row);
  }
}

function syncCheckboxes() {
  document.querySelectorAll('#harmonic-list input').forEach((inp, i) => {
    inp.checked = activeH[i];
    const row = inp.closest('.h-row');
    row.classList.toggle('on', activeH[i]);
    row.querySelector('.h-dot').style.background = activeH[i] ? H_COLORS[i] : '';
  });
}

function syncAmpBtns(mode) {
  document.querySelectorAll('.a-btn').forEach(b => b.classList.toggle('active', b.dataset.amp === mode));
}

// ── Event listeners ────────────────────────────────────────────────────────────
document.querySelectorAll('.p-btn[data-preset]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.p-btn[data-preset]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    applyPreset(btn.dataset.preset);
  });
});

document.querySelectorAll('.a-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    applyAmpMode(btn.dataset.amp);
    syncAmpBtns(btn.dataset.amp);
    draw();
  });
});

document.getElementById('play-btn').addEventListener('click', playTone);

document.getElementById('db-toggle').addEventListener('click', () => {
  specDb = !specDb;
  const btn = document.getElementById('db-toggle');
  btn.textContent = specDb ? 'dB' : 'Linear';
  btn.classList.toggle('active', specDb);
  document.getElementById('spectrum-title').innerHTML = specDb
    ? 'Spectrum &nbsp;·&nbsp; frequency domain &nbsp;·&nbsp; dB (re. |a|=1)'
    : 'Spectrum &nbsp;·&nbsp; frequency domain &nbsp;·&nbsp; linear';
  drawSpectrum();
});

// ── Init ───────────────────────────────────────────────────────────────────────
applyAmpMode('equal');
buildCheckboxes();
applyPreset('sine');
document.querySelector('[data-preset="sine"]').classList.add('active');

let rzTimer;
window.addEventListener('resize', () => { clearTimeout(rzTimer); rzTimer = setTimeout(draw, 80); });
requestAnimationFrame(draw);
</script>
</body>
</html>
